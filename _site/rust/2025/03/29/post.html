<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1"><!-- Begin Jekyll SEO tag v2.8.0 -->
<title>Minesweeper (1) | Your awesome title</title>
<meta name="generator" content="Jekyll v3.10.0" />
<meta property="og:title" content="Minesweeper (1)" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="So, minesweeper, interview problem at my job." />
<meta property="og:description" content="So, minesweeper, interview problem at my job." />
<link rel="canonical" href="http://localhost:4000/rust/2025/03/29/post.html" />
<meta property="og:url" content="http://localhost:4000/rust/2025/03/29/post.html" />
<meta property="og:site_name" content="Your awesome title" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2025-03-29T08:28:19+01:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="Minesweeper (1)" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2025-03-29T08:28:19+01:00","datePublished":"2025-03-29T08:28:19+01:00","description":"So, minesweeper, interview problem at my job.","headline":"Minesweeper (1)","mainEntityOfPage":{"@type":"WebPage","@id":"http://localhost:4000/rust/2025/03/29/post.html"},"url":"http://localhost:4000/rust/2025/03/29/post.html"}</script>
<!-- End Jekyll SEO tag -->
<link rel="stylesheet" href="/assets/main.css"><link type="application/atom+xml" rel="alternate" href="http://localhost:4000/feed.xml" title="Your awesome title" /></head>
<body><header class="site-header" role="banner">

  <div class="wrapper"><a class="site-title" rel="author" href="/">Your awesome title</a><nav class="site-nav">
        <input type="checkbox" id="nav-trigger" class="nav-trigger" />
        <label for="nav-trigger">
          <span class="menu-icon">
            <svg viewBox="0 0 18 15" width="18px" height="15px">
              <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z"/>
            </svg>
          </span>
        </label>

        <div class="trigger"><a class="page-link" href="/about/">About</a></div>
      </nav></div>

  <script type="text/javascript" id="MathJax-script" async
		  src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js">
  </script>
</header>
<main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title p-name" itemprop="name headline">Minesweeper (1)</h1>
    <p class="post-meta">
      <time class="dt-published" datetime="2025-03-29T08:28:19+01:00" itemprop="datePublished">Mar 29, 2025
      </time></p>
  </header>

  <div class="post-content e-content" itemprop="articleBody">
    <p>So, minesweeper, interview problem at my job.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Minesweeper C/C++ exercise
1. Generate a NxN Minesweeper-Board with B bombs positioned randomly.
   The parameters N and B are passed as command line arguments.
   N and B are positive integers, B is less than NxN.
  
2. For each position, display the number of bombs in the neighborhood.

Limited Time: 60 minutes.
Clarity and readability of the code will be evaluated first, correctness second.

Example:
$ ./minesweeper 5 2
board:
.*...
..*..
.....
.....
.....

neighbors:
1*21.
12*1.
.111.
.....
.....
</code></pre></div></div>
<p>So, this is just about generating a \(NxN\) square grid with \(B\) randomly positioned bombs and count the bombs. This is not about programming the game or solving it. My first version is <a href="https://github.com/Julien5/sandbox/blob/ae61a93e049e00a3115cbebe63aea0640fe2a147/test/rust/minesweeper/src/main.rs">here</a>. (It took me much more than one hour to do that). Nothing very exciting about this exercise, but if you think of (very) large grids, it can get interesting.</p>

<h2 id="generating-the-bombs">Generating the bombs</h2>

<p>For the \(B\) randomly positioned bombs, the first idea that comes to mind is the generate random numbers until we have \(B\) distinct numbers, like this</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>		let mut set=std::collections::HashSet::new();
		while set.len() != B {
			set.insert(rng.random_range(0..N*N));
		}
</code></pre></div></div>
<p>It works, but it make last long if there are many bombs (\(B\) close to \(N^2\).. think of the extreme case where the grid is full of bombs). (There is a trick: if \(B&gt;\frac{N^2}{2}\) we can invert the logic and generate bomb-free positions instead of bomb positions.) I wanted a fast, deterministic algorithm, privileging <a href="https://en.wikipedia.org/wiki/Time_complexity">time</a> over <a href="https://en.wikipedia.org/wiki/Space_complexity">space</a> complexity, I choose the <a href="https://en.wikipedia.org/wiki/Fisher%E2%80%93Yates_shuffle">FisherYates shuffle</a> which make \(B\) <em>distincts</em> random numbers out of any \(B\) random numbers, distincts or not. It has \(O(N^2)\) space complexity (memory requirement).</p>

<h2 id="counting-the-bombs">Counting the bombs</h2>

<p>Assuming \(B&lt;\frac{N^2}{2}\), it is faster to run across bomb positions than to run over all bomb-free positions:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>	let Bx = distinct_random_numbers(n*n,b);
	for p in &amp;Bx {
		grid[*p]=BOMB;
		increment_neighboors(&amp;mut grid,n,*p);
	}
</code></pre></div></div>
<p>In our first approach, the grid has length \(NxN\), and we must take care of the edges when iterating over the neighbors positions. This makes quite many <code class="language-plaintext highlighter-rouge">if</code>s.</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>fn increment_neighboors(grid:&amp;mut [usize], nu:usize, pos:usize) {
	// ...
	for dx in [-1,0,1] {
		let posnx=posx+dx;
		if posnx&lt;0 || posnx&gt;=n {
			continue;
		}
		for dy in [-1,0,1] {
			if dx == 0 &amp;&amp; dy == 0 {
				continue
			}
			let posny=posy+dy;
			if posny&lt;0 || posny&gt;=n {
				continue;
			}
			// ...
			// increment the neighboors count
			if grid[lu] != BOMB {
				grid[lu]+=1;
			}
		}
	}
}
</code></pre></div></div>
<p>This quite many <code class="language-plaintext highlighter-rouge">if</code>s is not very nice. Because of this, and because we want to parallelize, it makes sense to add “margins” to our grid, which gets length \((N+2)x(N+2)\).</p>

<h2 id="printing-the-grid">Printing the grid</h2>

<h2 id="multithreading">Multithreading</h2>

<p>We want to avoid using mutexes as much as possible. The idea is very simple: divide the large minesweeper grids into many small tiles (subgrids) of size \((X+2)x(Y+2)\) where \(X=N\) and \(Y=N/K\). Each tile as its margin, so that we dont loose neighbors for the bomb on the tile edges. When the tiles are merged together for printing, we must take properly care of those edges. This resulting algorithm is as follows:</p>
<ol>
  <li>Determine \(K\), the number of tiles. (This could be defined by the user.)</li>
  <li>For each k in \({0,...,K-1}\):
    <ul>
      <li>generate a chunk of \(B/K\) bomb positions.</li>
      <li>for each bomb chunk, create one tile, place the bombs and increment neighbors counts.</li>
    </ul>
  </li>
  <li>Aggregate the \(K\) tiles together and fix the counts on the tile edges.</li>
</ol>

<p>Step 2 can be done with concurrency because the chunks and the tiles are indepedant from each other. 
Step 3 could be done in parallel, but not with <a href="https://docs.rs/rayon/latest/rayon/">rayon</a> because of an <a href="https://github.com/rayon-rs/rayon/issues/592">issue</a>.</p>

<p>Implementation with explicit for loops:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>fn main(X:usize,Y:usize,Bchunk:usize,K:usize,quiet:bool) {
	for index in 0..K {
		let chunk=BombChunk::with_bomb_count(X,Y,index,Bchunk);
		let tile=make_tile(chunk);
	}
	let mut acc=TileAccumulator::init();
	acc.aggregate(tile);
	// todo: print
</code></pre></div></div>

<p>Reformulated with iterators and <a href="https://doc.rust-lang.org/stable/std/iter/trait.Iterator.html#method.map"><code class="language-plaintext highlighter-rouge">map</code></a>:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>fn main(X:usize,Y:usize,Bchunk:usize,K:usize,quiet:bool) {
	let mut acc=TileAccumulator::init();
	let _:Vec&lt;()&gt;=(0..K).into_iter()
		.map(|index| {
			let chunk=BombChunk::with_bomb_count(X,Y,index,Bchunk);
			let tile=make_tile(chunk);
			acc.aggregate(tile);
		}).collect();
	// todo: print	
</code></pre></div></div>

<p>And now just replaced iterator with <a href="https://docs.rs/rayon/latest/rayon/iter/index.html">parallel iterators</a>:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>fn main(X:usize,Y:usize,Bchunk:usize,K:usize,quiet:bool) {
	let tiles:Vec&lt;Tile&gt;=(0..K).into_par_iter()
		.map(|index| {
			let chunk=BombChunk::with_bomb_count(X,Y,index,Bchunk);
			make_tile(chunk)
		}).collect();
	let mut acc=TileAccumulator::init();
	for tile in tiles {
		acc.aggregate(tile);
	}
}
</code></pre></div></div>

<h2 id="notes">Notes</h2>

<h3 id="statistical-cost-of-chunking">Statistical Cost Of Chunking</h3>

<p>Generating bomb per tile has a “statistical” cost: the probability of the bomb distribution is not uniform over the large grid anymore. For example the probability of any chunk to have more (or less) than \(B/K\) bombs is zero. At this price we reduce the space complexity.</p>


  </div><a class="u-url" href="/rust/2025/03/29/post.html" hidden></a>
</article>

      </div>
    </main><footer class="site-footer h-card">
  <data class="u-url" href="/"></data>

  <div class="wrapper">

    <h2 class="footer-heading">Your awesome title</h2>

    <div class="footer-col-wrapper">
      <div class="footer-col footer-col-1">
        <ul class="contact-list">
          <li class="p-name">Your awesome title</li><li><a class="u-email" href="mailto:your-email@example.com">your-email@example.com</a></li></ul>
      </div>

      <div class="footer-col footer-col-2"><ul class="social-media-list"><li><a href="https://github.com/jekyll"><svg class="svg-icon"><use xlink:href="/assets/minima-social-icons.svg#github"></use></svg> <span class="username">jekyll</span></a></li><li><a href="https://www.twitter.com/jekyllrb"><svg class="svg-icon"><use xlink:href="/assets/minima-social-icons.svg#twitter"></use></svg> <span class="username">jekyllrb</span></a></li></ul>
</div>

      <div class="footer-col footer-col-3">
        <p>Write an awesome description for your new site here. You can edit this line in _config.yml. It will appear in your document head meta (for Google search results) and in your feed.xml site description.</p>
      </div>
    </div>

  </div>

</footer>
</body>

</html>
